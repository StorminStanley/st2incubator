---
  chain:
    -
      name: "get_lock"
      ref: "core.local"
      params:
        cmd: "st2 key get \"mistral.lock\" | grep foo"
      on-success: "slack_lock_failure"
      on-failure: "set_lock"
    -
      name: "set_lock"
      ref: "core.local"
      params:
        cmd: "st2 key set key=\"mistral.lock\" value=\"1\""
      on-success: "get_build_server"
      on-failure: "slack_lock_acquire_failure"
    -
      name: "get_build_server"
      ref: "linux.dig"
      params:
        hostname: "st2-build-slave-itests-ubuntu.service.consul"
        rand: true
        count: 1
      on-success: "clone_st2_repo"
      on-failure: "slack_failure"
    -
      name: "clone_st2_repo"
      ref: "st2cd.git_clone"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{st2_repo}}"
        branch: "{{st2_repo_branch}}"
        target: "{{st2_repo_target}}"
      on-success: "clone_mistral_repo"
      on-failure: "slack_failure"
    -
      name: "clone_mistral_repo"
      ref: "st2cd.git_clone"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{mistral_fork}}"
        branch: "{{mistral_fork_branch}}"
        target: "{{mistral_fork_target}}"
      on-success: "clone_st2mistral_repo"
      on-failure: "slack_failure"
    -
      name: "clone_st2mistral_repo"
      ref: "st2cd.git_clone"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{st2mistral_repo}}"
        branch: "{{st2mistral_repo_branch}}"
        target: "{{st2mistral_repo_target}}"
      on-success: "clone_mistral_client_repo"
      on-failure: "slack_failure"
    -
      name: "clone_mistral_client_repo"
      ref: "st2cd.git_clone"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{mistral_client_repo}}"
        branch: "{{mistral_client_repo_branch}}"
        target: "{{mistral_client_repo_target}}"
      on-success: "install_mistral_client"
      on-failure: "slack_failure"
    -
      name: "install_mistral_client"
      ref: "st2cd.install_mistral_client"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_mistral_client_repo[get_build_server.result[0]].stdout}}"
        branch: "{{mistral_client_repo_branch}}"
      on-success: "install_mistral"
      on-failure: "slack_failure"
    -
      name: "install_mistral"
      ref: "st2cd.install_mistral"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_mistral_repo[get_build_server.result[0]].stdout}}"
        branch: "{{mistral_fork_branch}}"
        st2action_dir: "{{clone_st2mistral_repo[get_build_server.result[0]].stdout}}"
      on-success: "setup_mistral_upstart"
      on-failure: "slack_failure"
    -
      name: "setup_mistral_upstart"
      ref: "st2cd.setup_mistral_upstart"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_mistral_repo[get_build_server.result[0]].stdout}}"
      on-success: "run_mistral"
      on-failure: "slack_failure"
    -
      name: "run_mistral"
      ref: "st2cd.run_mistral"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_mistral_repo[get_build_server.result[0]].stdout}}"
      on-success: "run_st2"
      on-failure: "slack_failure"
    -
      name: "run_st2"
      ref: "st2cd.run_st2"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_st2_repo[get_build_server.result[0]].stdout}}"
      on-success: "run_mistral_itests"
      on-failure: "slack_failure"
    -
      name: "run_mistral_itests"
      ref: "st2cd.run_mistral_itests"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_st2_repo[get_build_server.result[0]].stdout}}"
        timeout: 600
      on-success: "clean_st2_repo"
      on-failure: "slack_failure"
    -
      name: "clean_st2_repo"
      ref: "st2cd.git_clean"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_st2_repo[get_build_server.result[0]].stdout}}"
      on-success: "clean_mistral_repo"
      on-failure: "slack_failure"
    -
      name: "clean_mistral_repo"
      ref: "st2cd.git_clean"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_mistral_repo[get_build_server.result[0]].stdout}}"
      on-success: "clean_st2mistral_repo"
      on-failure: "slack_failure"
    -
      name: "clean_st2mistral_repo"
      ref: "st2cd.git_clean"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_st2mistral_repo[get_build_server.result[0]].stdout}}"
      on-success: "clean_mistral_client_repo"
      on-failure: "slack_failure"
    -
      name: "clean_mistral_client_repo"
      ref: "st2cd.git_clean"
      params:
        hosts: "{{get_build_server.result[0]}}"
        repo: "{{clone_mistral_client_repo[get_build_server.result[0]].stdout}}"
      on-success: "teardown_mistral_itests"
      on-failure: "slack_failure"
    -
      name: "teardown_mistral_itests"
      ref: "st2cd.teardown_mistral_itests"
      params:
        hosts: "{{get_build_server.result[0]}}"
        st2_repo: "{{clone_st2_repo[get_build_server.result[0].stdout}}"
        drop_st2_db: "true"
      on-success: "slack_success"
      on-failure: "slack_failure"
    -
      name: "release_lock"
      ref: "st2cd.kvstore"
      params:
        action: "delete"
        key: "mistral.lock"
    -
      name: "slack_success"
      ref: "slack.post_message"
      params:
        channel: "#thunderdome"
        message: "```[MISTRAL_ITESTS]\n STATUS: SUCCEEDED.\n```"
      on-success: "release_lock"
      on-failure: "release_lock"
    -
      name: "slack_failure"
      ref: "slack.post_message"
      params:
        channel: "#thunderdome"
        message: "```[MISTRAL_ITESTS]\n STATUS: FAILED.\n```"
      on-success: "release_lock"
      on-failure: "release_lock"
    -
      name: "slack_lock_failure"
      ref: "slack.post_message"
      params:
        channel: "#thunderdome"
        message: "```[MISTRAL_ITESTS]\n STATUS: ALREADY_RUNNING.\n```"
    -
      name: "slack_lock_acquire_failure"
      ref: "slack.post_message"
      params:
        channel: "#thunderdome"
        message: "```[MISTRAL_ITESTS]\n STATUS: LOCKING_FAILED.\n```"

  default: "get_lock"
